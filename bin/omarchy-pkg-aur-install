#!/bin/bash

# FEDARCHY: Enhanced AUR installer with auto-export functionality
# Installs AUR packages via distrobox and automatically exports them

fzf_args=(
  --multi
  --preview 'distrobox enter arch-aur -- yay -Sii {1}'
  --preview-label='alt-p: toggle description, alt-j/k: scroll, tab: multi-select, F11: maximize'
  --preview-label-pos='bottom'
  --preview-window 'down:65%:wrap'
  --bind 'alt-p:toggle-preview'
  --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
  --bind 'alt-k:preview-up,alt-j:preview-down'
  --color 'pointer:green,marker:green'
)

# Get AUR package list from container
pkg_names=$(distrobox enter arch-aur -- yay -Slqa | fzf "${fzf_args[@]}")

if [[ -n "$pkg_names" ]]; then
  # Install and export each package
  while IFS= read -r package; do
    [[ -z "$package" ]] && continue

    echo "Installing $package from AUR..."
    if distrobox enter arch-aur -- yay -S --noconfirm "$package"; then
      # Auto-export if package has desktop entry
      if distrobox-export --app "$package" 2>/dev/null; then
        echo "✓ $package installed and exported as native app"
      else
        echo "✓ $package installed (no desktop entry to export)"
      fi
    else
      echo "✗ Failed to install $package"
    fi
  done <<< "$pkg_names"

  # Update locate database
  sudo updatedb 2>/dev/null || true
  omarchy-show-done
fi
